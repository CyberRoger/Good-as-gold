<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Spot Price and Sharesies Gold ETF in NZD</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 10px auto;
            padding: 10px;
            text-align: center;
        }
        .warning {
            background-color: #ffe6e6;
            border: 2px solid #ff3333;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #333;
        }
        .section {
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .price {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        .indicator {
            font-size: 1.3em;
            margin: 8px 0;
        }
        .up {
            color: green;
        }
        .down {
            color: red;
        }
        .no-change {
            color: gray;
        }
        button {
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
        }
        .last-updated {
            font-size: 0.8em;
            color: #555;
        }
        .debug {
            font-size: 0.7em;
            color: #777;
            margin-top: 8px;
        }
        .note {
            font-size: 0.7em;
            color: #777;
        }
    </style>
</head>
<body>
    <div class="warning">
        WARNING: This program has not been fully tested. The displayed prices and daily changes for gold spot and Sharesies Gold ETF (GLD) may be incorrect. Verify data with official sources before making decisions.
    </div>
    <h1>Live Gold Prices in NZD</h1>
    
    <div class="section">
        <h2>Gold Spot Price (per Ounce)</h2>
        <div id="spot-price">Loading...</div>
        <div id="spot-indicator" class="indicator">Loading...</div>
        <div id="spot-last-updated" class="last-updated">Last updated: Loading...</div>
        <div id="spot-debug" class="debug">Checking data source...</div>
        <p class="note">Daily change reflects today's trading day in NZ time (NZST/NZDT). Data sourced from livepriceofgold.com.</p>
    </div>
    
    <div class="section">
        <h2>Sharesies Gold ETF (GLD) Price (per Unit)</h2>
        <div id="etf-price">Loading...</div>
        <div id="etf-indicator" class="indicator">Loading...</div>
        <div id="etf-last-updated" class="last-updated">Last updated: Loading...</div>
        <div id="etf-debug" class="debug">Checking data source...</div>
        <p class="note">Daily change reflects NZX trading day (10:00 AM–4:45 PM NZST/NZDT). Data sourced from Yahoo Finance.</p>
    </div>
    
    <button onclick="fetchPrices()">Refresh Prices</button>

    <script>
        let spotPreviousClose = null;
        let etfPreviousClose = null;

        function getNZTime() {
            return new Date().toLocaleString('en-NZ', {
                timeZone: 'Pacific/Auckland',
                hour12: false
            });
        }

        function isNewDayNZ() {
            const nzTime = new Date().toLocaleString('en-US', { timeZone: 'Pacific/Auckland' });
            const hours = new Date(nzTime).getHours();
            return hours >= 3;
        }

        function fetchSpotPrice() {
            fetch('https://corsproxy.io/?https://www.livepriceofgold.com/nz-gold-price.html')
                .then(response => response.text())
                .then(currentHtml => {
                    const currentParser = new DOMParser();
                    const currentDoc = currentParser.parseFromString(currentHtml, 'text/html');

                    let currentPrice = null;
                    const priceSelectors = ['.price-value', '.spot-price', '.gold-price', 'h2', 'h3', 'td', 'span', '.current-price', '[data-price]', '.goldprice', '.price', '[data-test="price"]'];
                    for (let selector of priceSelectors) {
                        const elements = currentDoc.querySelectorAll(selector);
                        for (let el of elements) {
                            const text = el.textContent.replace(/[^\d.]/g, '');
                            const price = parseFloat(text);
                            if (price > 5000 && price < 8000) {
                                currentPrice = price;
                                break;
                            }
                        }
                        if (currentPrice) break;
                    }

                    if (!currentPrice) {
                        document.getElementById('spot-price').textContent = 'Data not currently available';
                        document.getElementById('spot-indicator').textContent = '';
                        document.getElementById('spot-last-updated').textContent = `Last updated: ${getNZTime()}`;
                        document.getElementById('spot-debug').textContent = 'Data source: Fetch failed (check livepriceofgold.com)';
                        return;
                    }

                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    fetch('https://corsproxy.io/?https://www.livepriceofgold.com/gold-price-history.html?date=' + yesterdayStr)
                        .then(response => response.text())
                        .then(yesterdayHtml => {
                            const yesterdayParser = new DOMParser();
                            const yesterdayDoc = yesterdayParser.parseFromString(yesterdayHtml, 'text/html');

                            let previousClose = null;
                            const prevSelectors = ['.price-value', '.spot-price', 'h2', 'h3', 'td', 'span', '.current-price', '[data-price]', '.goldprice', '.price', '[data-test="price"]'];
                            for (let selector of prevSelectors) {
                                const elements = yesterdayDoc.querySelectorAll(selector);
                                for (let el of elements) {
                                    const text = el.textContent.replace(/[^\d.]/g, '');
                                    const price = parseFloat(text);
                                    if (price > 5000 && price < 8000) {
                                        previousClose = price;
                                        break;
                                    }
                                }
                                if (previousClose) break;
                            }

                            if (!previousClose) {
                                document.getElementById('spot-price').textContent = 'Data not currently available';
                                document.getElementById('spot-indicator').textContent = '';
                                document.getElementById('spot-last-updated').textContent = `Last updated: ${getNZTime()}`;
                                document.getElementById('spot-debug').textContent = 'Data source: Fetch failed (check livepriceofgold.com history)';
                                return;
                            }

                            let change = currentPrice - previousClose;
                            let changePct = (change / previousClose) * 100;

                            if (Math.abs(changePct) > 5) {
                                document.getElementById('spot-price').textContent = 'Data not currently available';
                                document.getElementById('spot-indicator').textContent = '';
                                document.getElementById('spot-last-updated').textContent = `Last updated: ${getNZTime()}`;
                                document.getElementById('spot-debug').textContent = 'Data source: Invalid change detected';
                                return;
                            }

                            if (isNewDayNZ() || spotPreviousClose === null) {
                                spotPreviousClose = previousClose;
                            }

                            document.getElementById('spot-price').textContent = `NZD $${currentPrice.toFixed(2)}`;
                            const spotIndicator = document.getElementById('spot-indicator');
                            if (change > 0) {
                                spotIndicator.innerHTML = `↑ +NZD $${change.toFixed(2)} (+${changePct.toFixed(2)}%)`;
                                spotIndicator.className = 'indicator up';
                            } else if (change < 0) {
                                spotIndicator.innerHTML = `↓ -NZD $${Math.abs(change).toFixed(2)} (${changePct.toFixed(2)}%)`;
                                spotIndicator.className = 'indicator down';
                            } else {
                                spotIndicator.innerHTML = '→ No change today';
                                spotIndicator.className = 'indicator no-change';
                            }
                            document.getElementById('spot-last-updated').textContent = `Last updated: ${getNZTime()}`;
                            document.getElementById('spot-debug').textContent = 'Data source: Live calculation successful';
                        })
                        .catch(error => {
                            document.getElementById('spot-price').textContent = 'Data not currently available';
                            document.getElementById('spot-indicator').textContent = '';
                            document.getElementById('spot-last-updated').textContent = `Last updated: ${getNZTime()}`;
                            document.getElementById('spot-debug').textContent = 'Data source: Fetch failed (check livepriceofgold.com history)';
                            console.error('Error fetching yesterday data:', error);
                        });
                })
                .catch(error => {
                    document.getElementById('spot-price').textContent = 'Data not currently available';
                    document.getElementById('spot-indicator').textContent = '';
                    document.getElementById('spot-last-updated').textContent = `Last updated: ${getNZTime()}`;
                    document.getElementById('spot-debug').textContent = 'Data source: Fetch failed (check livepriceofgold.com)';
                    console.error('Error fetching current price:', error);
                });
        }

        function fetchEtfPrice() {
            fetch('https://corsproxy.io/?https://nz.finance.yahoo.com/quote/GLD.NZ')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    let currentPrice = null;
                    const priceSelectors = [
                        'fin-streamer[data-field="regularMarketPrice"]',
                        '[data-test="qsp-price"]',
                        '.Fw\\(b\\)',
                        '.price',
                        '[data-reactid]',
                        'span',
                        'h2',
                        'h3',
                        '.value',
                        '.last-price',
                        '.symbol-price',
                        '[data-symbol="GLD.NZ"]',
                        '[data-test="qsp-price"]',
                        '.market-price'
                    ];
                    for (let selector of priceSelectors) {
                        const elements = doc.querySelectorAll(selector);
                        for (let el of elements) {
                            const text = el.textContent.replace(/[^\d.]/g, '');
                            const price = parseFloat(text);
                            if (price > 2 && price < 5) {
                                currentPrice = price;
                                break;
                            }
                        }
                        if (currentPrice) break;
                    }

                    if (!currentPrice) {
                        document.getElementById('etf-price').textContent = 'Data not currently available';
                        document.getElementById('etf-indicator').textContent = '';
                        document.getElementById('etf-last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                        document.getElementById('etf-debug').textContent = 'Data source: Fetch failed (check nz.finance.yahoo.com)';
                        return;
                    }

                    let change = null;
                    const changeSelectors = [
                        'fin-streamer[data-field="regularMarketChange"]',
                        '[data-test="qsp-price-change"]',
                        '.Fz\\(36px\\)',
                        '.change',
                        '[data-reactid]',
                        'span',
                        '.delta',
                        '[data-test="qsp-price-change"]'
                    ];
                    for (let selector of changeSelectors) {
                        const elements = doc.querySelectorAll(selector);
                        for (let el of elements) {
                            const text = el.textContent;
                            const changeMatch = text.match(/([+-]?\d*\.?\d+)/);
                            if (changeMatch) {
                                const parsedChange = parseFloat(changeMatch[0]);
                                if (Math.abs(parsedChange) < 0.5) {
                                    change = parsedChange;
                                    break;
                                }
                            }
                        }
                        if (change !== null) break;
                    }

                    let changePct = null;
                    const pctSelectors = [
                        'fin-streamer[data-field="regularMarketChangePercent"]',
                        '[data-test="qsp-price-change-percent"]',
                        '.change',
                        '[data-reactid]',
                        'span',
                        '.pct-change',
                        '[data-test="qsp-price-change-percent"]'
                    ];
                    for (let selector of pctSelectors) {
                        const elements = doc.querySelectorAll(selector);
                        for (let el of elements) {
                            const text = el.textContent;
                            const pctMatch = text.match(/([+-]?\d*\.?\d+)%/);
                            if (pctMatch) {
                                const parsedPct = parseFloat(pctMatch[1]);
                                if (Math.abs(parsedPct) < 5) {
                                    changePct = parsedPct;
                                    break;
                                }
                            }
                        }
                        if (changePct !== null) break;
                    }

                    if (change === null || changePct === null) {
                        if (etfPreviousClose !== null) {
                            change = currentPrice - etfPreviousClose;
                            changePct = (change / etfPreviousClose) * 100;
                        } else {
                            document.getElementById('etf-price').textContent = 'Data not currently available';
                            document.getElementById('etf-indicator').textContent = '';
                            document.getElementById('etf-last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                            document.getElementById('etf-debug').textContent = 'Data source: Fetch failed (check nz.finance.yahoo.com)';
                            return;
                        }
                    }

                    if (etfPreviousClose === null) {
                        etfPreviousClose = currentPrice - change;
                    }

                    document.getElementById('etf-price').textContent = `NZD $${currentPrice.toFixed(3)}`;
                    const etfIndicator = document.getElementById('etf-indicator');
                    if (change > 0) {
                        etfIndicator.innerHTML = `↑ +NZD $${change.toFixed(3)} (+${changePct.toFixed(2)}%)`;
                        etfIndicator.className = 'indicator up';
                    } else if (change < 0) {
                        etfIndicator.innerHTML = `↓ -NZD $${Math.abs(change).toFixed(3)} (${changePct.toFixed(2)}%)`;
                        etfIndicator.className = 'indicator down';
                    } else {
                        etfIndicator.innerHTML = '→ No change today';
                        etfIndicator.className = 'indicator no-change';
                    }
                    document.getElementById('etf-last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                    document.getElementById('etf-debug').textContent = 'Data source: Live fetch successful';
                })
                .catch(error => {
                    document.getElementById('etf-price').textContent = 'Data not currently available';
                    document.getElementById('etf-indicator').textContent = '';
                    document.getElementById('etf-last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                    document.getElementById('etf-debug').textContent = 'Data source: Fetch failed (check nz.finance.yahoo.com)';
                    console.error('Error fetching ETF price:', error);
                });
        }

        function fetchPrices() {
            fetchSpotPrice();
            fetchEtfPrice();
        }

        fetchPrices();
        setInterval(fetchPrices, 30000);
    </script>
</body>
</html>
